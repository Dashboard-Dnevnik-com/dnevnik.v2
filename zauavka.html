<?php
include 'db.php';
$message = "";

// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —à–∫–æ–ª—ã ---
if (isset($_POST['add_school'])) {
    $name = $_POST['name'];
    $license = $_POST['license'];
    $phone = $_POST['phone'];
    $email = $_POST['email'];
    $username = strtolower(str_replace(' ', '', $name)) . rand(100,999);
    $password = substr(str_shuffle("abcdefghijklmnopqrstuvwxyz0123456789"),0,8);
    $hash = password_hash($password, PASSWORD_DEFAULT);

    $stmt = $conn->prepare("INSERT INTO schools (name, license, phone, email, username, password) VALUES (?,?,?,?,?,?)");
    $stmt->bind_param("ssssss",$name,$license,$phone,$email,$username,$hash);
    if ($stmt->execute()) {
        $message = "‚úÖ –®–∫–æ–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞! –õ–æ–≥–∏–Ω: <b>$username</b> –ü–∞—Ä–æ–ª—å: <b>$password</b>";
    } else $message = "‚ùå –û—à–∏–±–∫–∞: ".$stmt->error;
}

// --- –î–µ–π—Å—Ç–≤–∏—è —Å —à–∫–æ–ª–æ–π ---
if (isset($_GET['action']) && isset($_GET['id'])) {
    $id = intval($_GET['id']);
    if ($_GET['action'] == 'delete') {
        $conn->query("DELETE FROM schools WHERE id=$id");
    }
    if ($_GET['action'] == 'suspend') {
        $conn->query("UPDATE schools SET status='suspended' WHERE id=$id");
    }
    if ($_GET['action'] == 'activate') {
        $conn->query("UPDATE schools SET status='active' WHERE id=$id");
    }
    if ($_GET['action'] == 'reset') {
        $new_pass = substr(str_shuffle("abcdefghijklmnopqrstuvwxyz0123456789"),0,8);
        $hash = password_hash($new_pass,PASSWORD_DEFAULT);
        $conn->query("UPDATE schools SET password='$hash' WHERE id=$id");
        $message = "üîë –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: $new_pass";
    }
}

// --- –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —à–∫–æ–ª—ã ---
$result = $conn->query("SELECT * FROM schools ORDER BY id DESC");
?>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∫–æ–ª–∞–º–∏</title>
<style>
body { font-family: Arial; padding:20px; background:#f5f7fa; }
.container { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
table { width:100%; border-collapse: collapse; margin-top:20px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:center; }
a { text-decoration:none; padding:4px 8px; border-radius:4px; color:white; }
a.delete { background:red; }
a.suspend { background:orange; }
a.activate { background:green; }
a.reset { background:blue; }
form input { padding:8px; margin:5px; width:150px; }
button { padding:8px 12px; }
.message { background:#eef; padding:10px; margin:10px 0; border-radius:5px; }
</style>
</head>
<body>
<div class="container">
<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∫–æ–ª–∞–º–∏</h2>

<?php if($message) echo "<div class='message'>$message</div>"; ?>

<h3>–î–æ–±–∞–≤–∏—Ç—å —à–∫–æ–ª—É</h3>
<form method="post">
    <input name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
    <input name="license" placeholder="–õ–∏—Ü–µ–Ω–∑–∏—è">
    <input name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
    <input name="email" placeholder="Email">
    <button name="add_school">–î–æ–±–∞–≤–∏—Ç—å</button>
</form>

<h3>–í—Å–µ —à–∫–æ–ª—ã</h3>
<table>
<tr>
<th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–õ–∏—Ü–µ–Ω–∑–∏—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>Email</th><th>–õ–æ–≥–∏–Ω</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
</tr>
<?php while($row = $result->fetch_assoc()): ?>
<tr>
<td><?= $row['id'] ?></td>
<td><?= htmlspecialchars($row['name']) ?></td>
<td><?= htmlspecialchars($row['license']) ?></td>
<td><?= htmlspecialchars($row['phone']) ?></td>
<td><?= htmlspecialchars($row['email']) ?></td>
<td><?= htmlspecialchars($row['username']) ?></td>
<td><?= $row['status'] ?></td>
<td>
<?php if($row['status']=='active'): ?>
<a href="?action=suspend&id=<?= $row['id'] ?>" class="suspend">–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</a>
<?php else: ?>
<a href="?action=activate&id=<?= $row['id'] ?>" class="activate">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</a>
<?php endif; ?>
<a href="?action=reset&id=<?= $row['id'] ?>" class="reset">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</a>
<a href="?action=delete&id=<?= $row['id'] ?>" class="delete" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —à–∫–æ–ª—É?')">–£–¥–∞–ª–∏—Ç—å</a>
</td>
</tr>
<?php endwhile; ?>
</table>
</div>
</body>
</html>
